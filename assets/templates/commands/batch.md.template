# Execute Multiple OpenSpec Changes with Hive Orchestration

Execute a batch of OpenSpec changes with intelligent dependency resolution and coordinated implementation.

---

## MANDATORY EXECUTION RULES - NO EXCEPTIONS

**YOU ARE FORBIDDEN FROM:**
- Writing code directly yourself
- Editing files without spawning agents
- Skipping swarm initialization
- "Manually" implementing anything
- Taking shortcuts or "just doing it yourself"
- Reading files and then implementing - that's what agents are for

**YOU MUST:**
- Initialize the swarm FIRST (Step 2)
- Spawn task-orchestrator agent for each change
- Let agents do ALL the work
- Only monitor and report progress

**IF YOU SKIP THESE STEPS, YOU ARE FAILING YOUR CORE RESPONSIBILITY.**

The entire point of this system is multi-agent orchestration. If you implement directly, you defeat the purpose and waste the infrastructure that was built.

---

## Task

### Step 1: Analyze Dependencies and Build Execution Plan

Run the batch analysis command with all change IDs:

```bash
openspec-flow batch <CHANGE_ID_1> <CHANGE_ID_2> <CHANGE_ID_3>
```

**Carefully review the output** to understand:
- Dependency relationships between changes
- Execution order (topologically sorted)
- Which changes can run in parallel (if any)
- Validation results

### Step 2: Initialize Swarm (MANDATORY - DO THIS NOW)

**IMMEDIATELY** call this MCP tool - no exceptions:

```
mcp__claude-flow__swarm_init({
  topology: "hierarchical",
  maxAgents: 8,
  strategy: "adaptive"
})
```

**DO NOT PROCEED WITHOUT SWARM INITIALIZATION.**

### Step 3: Create Todo List for Tracking

Use TodoWrite to create a todo list with one item per change:

```
- [ ] Implement <CHANGE_ID_1>
- [ ] Implement <CHANGE_ID_2>
- [ ] Implement <CHANGE_ID_3>
```

This helps track progress through the batch execution.

### Step 4: Execute Changes in Dependency Order (VIA AGENTS ONLY)

For **each change** in the execution order:

#### 4.1: Mark Current Change as In Progress

Update the todo list to mark the current change as `in_progress`.

#### 4.2: Load Context Documents (READ ONLY - NO IMPLEMENTATION)

Load these files to pass to the orchestrator:

1. **Work Brief** (auto-generated by batch command):
   ```
   openspec/changes/<CHANGE_ID>/work-brief.md
   ```

2. **Proposal**:
   ```
   openspec/changes/<CHANGE_ID>/proposal.md
   ```

3. **Tasks**:
   ```
   openspec/changes/<CHANGE_ID>/tasks.md
   ```

4. **Project Context** (if not already loaded):
   - `CLAUDE.md`
   - `CLAUDE-FLOW.md`

#### 4.3: Spawn Task Orchestrator (MANDATORY - DO THIS NOW)

**IMMEDIATELY** spawn the orchestrator agent using the Task tool:

```
Task({
  subagent_type: "task-orchestrator",
  description: "Orchestrate OpenSpec <CHANGE_ID> implementation",
  prompt: <FULL ORCHESTRATOR PROMPT - SEE /openspec-flow:implement FOR TEMPLATE>
})
```

The orchestrator will:
- Analyze work brief and break into discrete tasks
- Spawn coder, tester, reviewer agents as needed
- Coordinate implementation phases
- Validate outputs after each phase
- Handle error recovery

**YOU DO NOT IMPLEMENT ANYTHING DIRECTLY - THE ORCHESTRATOR AND ITS AGENTS DO ALL THE WORK.**

#### 4.4: Monitor Progress

While orchestrator runs:
- Check `mcp__claude-flow__swarm_status` periodically
- Report agent activity to user
- Do NOT intervene unless orchestrator requests help


#### 4.5: Verify Implementation

The orchestrator's reviewer agent should have verified, but confirm:

1. **Build Check**:
   ```bash
   {{build.command}}
   ```
   Must succeed with 0 warnings.

2. **Run Tests**:
   ```bash
   {{test.command}}
   ```
   All tests must pass.

3. **Review Against Requirements**:
   - All tasks in `tasks.md` completed
   - All success criteria from proposal met

#### 4.6: Mark Change Complete

Only after verification passes:
- Update todo list marking current change as `completed`
- Update task checklist in `tasks.md` (mark tasks with `[x]`)
- Move to next change in execution order

### Step 5: Handle Dependencies

**CRITICAL**: Do not start a change until all its dependencies are completed.

- If Change B depends on Change A, complete A first
- Verify dependency completion before starting dependent change
- The batch analysis showed you the correct order - follow it strictly

### Step 6: Cleanup Swarm

After all changes are complete:

```
mcp__claude-flow__swarm_destroy({ swarmId: "<swarm-id>" })
```

### Step 7: Final Summary

After all changes are complete:

1. List all changes implemented
2. Show final test results
3. Recommend next steps:
   - Archive completed changes
   - Create PR (if appropriate)
   - Run integration tests
   - Deploy to dev environment

## Example Usage

For a multi-phase feature:

```bash
openspec-flow batch 0.2.1-define-contracts 0.2.2-implement-backend 0.2.3-implement-frontend
```

**Execution Order**:
1. Implement 0.2.1 (API contracts only, pure spec)
2. Verify and mark complete
3. Implement 0.2.2 (backend, uses contracts from 0.2.1)
4. Run tests, verify, mark complete
5. Implement 0.2.3 (frontend, uses contracts and backend)
6. Run tests, verify, mark complete
7. Provide summary

## Important Notes

- **Dependencies are Critical**: Never skip ahead in the execution order
- **One at a Time**: Fully complete each change before starting next
- **Test Everything**: Run tests after each change
- **Track Progress**: Keep todo list updated for visibility

## Quality Gates

Each change must pass:
- Build succeeds (`{{build.command}}`)
- All tests pass (`{{test.command}}`)
- Code follows project conventions
- All tasks in `tasks.md` completed
- Success criteria from proposal met

Only then mark as complete and proceed to next change.

---

## VERIFICATION CHECKLIST

Before considering this command complete, verify:

- [ ] `mcp__claude-flow__swarm_init` was called
- [ ] Task tool spawned task-orchestrator agent for each change
- [ ] Orchestrators spawned child agents (coder, tester, reviewer)
- [ ] NO direct file edits were made by the main assistant
- [ ] `mcp__claude-flow__swarm_destroy` was called for cleanup

**If any checkbox is unchecked, the command was executed incorrectly.**

---

This is **hive orchestration** - intelligently coordinating multiple changes with dependency awareness and quality gates at every step.
